import csv as csv
class emne:
    def __init__(self, kode, semester, navn, stp):
        self.kode = kode
        self.semester = semester
        self.navn = navn
        self.stp = stp
        
    def __str__(self):
        return f"{self.navn}, {self.kode}, {self.semester}, {self.stp}"            
        
class studieplan:
    def __init__(self, ID, tittel):
        self.ID = ID
        self.tittel = tittel
        self.semestre = {i:[] for i in range(1,7)}

        #den vil da printe ut slik:
        """
        self.semester1 = []
        self.semester2 = []
        self.semester3 = []
        self.semester4 = []
        self.semester5 = []
        self.semester6 = [] 
        """

    def __str__(self):
        return f"{self.ID}, {self.tittel}, {self.semestre}"
    
    def fjern(self, nr, emne): #Metode for å fjrene et emne fra studieplanen.
        self.semestre[nr].remove(emne)
        print(f"Fjernet {emne} fra semester {nr}.")

    def legg_emne_i_studieplan(self, emne): #Metode for å legge til et emne i studieplanen.
        try:
            nr = int(input("Oppgi semester (1-6):"))
        except: ValueError("Velg et semester 1-6.")
        self.semester[nr].append(emne)
        print(f"La til {emne} i studieplanen.")

class emneregister:
    def __init__(self):
        self._emner = []
        
    def __str__(self): #Metode for å vise alle oprettede emner (4)
        tekst = ""
        for emne in self._emner:
            tekst += str(emne) + "\n" 
            return tekst
        
    def legg_emne_i_register(self, emne): #Metode for å legge emnet i register (1)
        self._emner.append(emne)
        print(f"{emne} lagt til i emneregister.")
        
    def finn(self, kode): #Metode for å referere til et emneobjekt, i stedet for å bruke liste-indeks
        for fag in self._emner:
            if fag.kode == kode:
                return fag
        return None
        
    def slett(self, kode): #Metode for å slette opprettet emne
        for fag in self._emner:
            if fag.kode == emne.kode:
                del fag
                print(f"Slettet {fag}.")

emneliste = emneregister() #Globalt emneregister-objekt, kan i teorien lage flere registere, men trengs ikke her
studieplan_dict = {}


def meny_liste():
    print("\n________Meny:_______")   
    print("01. Lag et nytt emne.")
    print("02. Legg til et emne i studieplanen.")
    print("03. Fjern et emne fra en studieplan.")
    print("04. Skriv ut ei liste over alle registrerte emner.")
    print("05. Lag en ny tom studieplan.")
    print("06. Skriv ut en studieplan med hvilke emner som er i hvert semester.")
    print("07. Sjekk om en studieplan er gyldig eller ikke.")
    print("08. Finn hvilke studieplaner som bruker et oppgitt emne.")    
    print("09. Lagre emnene og studieplanene til fil.")
    print("10. Les inn emnene og studieplanene fra fil.")  
    print("11. Avslutt.")


def valg1():
    emnekode = input("Skriv inn emnekode: ")
    navn = input("Skriv inn navn på emnet: ")
    semester_input = int(input("Skriv inn 1 for høst eller 2 for vår: ")) 

    if semester_input == 1: 
        semester = "H"
    elif semester_input == 2:
        semester = "V"
    else:
        print("vennligst velg 1 (for høst) eller 2 (for vår)")  
    try:
        studiepoeng = int(input("Skriv inn studie poeng: "))
    except ValueError:
        print("Skriv et tall")
        return
    
    emnet = emne(emnekode, semester, navn, studiepoeng)
    emneliste.legg_emne_i_register(emnet)
    
def valg2():
    if not studieplan_dict:
        print("Finnes ingen studieplaner lag en først takk :-)")
        return
    if not emneliste._emner :
        print("Ops da, du har visst ikke laget noen emner enda")
        return
    print("Studieplaner")
    for plan_navn in studieplan_dict:
        print(f"---{plan_navn}")


    plan_navn = input("Velg studieplan")
    if plan_navn not in studieplan_dict:
        print("studieplanenen finnes ikke :-(")
        return
    
    print("Emner: ")
    for emne in emneliste._emner: #T1, for å vite hvilke emner som finnes før du velger. 
        print(f"{emne.kode}")

    emnekode = input("skriv inn emnekoden du ønsker å legge til")
    emne_obj = emneliste.finn(emnekode)
    if not emne_obj:
        print("fant ikke emnet du lette etter :-(")
        return
    try:
        semester = int(input("Hvilket semester 1-6"))
        if semester < 1 or semester >6:
            raise ValueError
    except ValueError:
        print("Skriv et gyldig tall takk")
        return
    semester_sesong = {1:"H", 2:"V", 3:"H", 4:"V", 5:"H", 6:"V"}
    if emne_obj.semester != semester_sesong[semester]:
        print(f"Kan ikke legge {emne_obj.navn}  i semester {semester} fordi det er feil sesong")
        return
    studieplan_dict[plan_navn].semestre[semester].append(emne_obj)
    print(f"da ble {emne_obj.navn} ({emne_obj.kode}) lagt til i semester {semester} på {plan_navn}.")

def valg3():
    if not studieplan_dict:
        print("Du må nok lage en studieplan før du planlegger å fjerne emner")
        return
    
    print("Studieplaner")
    for plan_navn in studieplan_dict:
        print(f"---{plan_navn}")
        
    plan_navn = input("Velg studieplan")
    if plan_navn not in studieplan_dict:
        print("studieplanenen finnes ikke :-(")
        return
    try:
        semester = int(input("Hvilket semester 1-6"))
        if semester < 1 or semester >6:
            raise ValueError
    except ValueError:
        print("Skriv et gyldig tall takk")
        return
    plan = studieplan_dict[plan_navn]
    emnelister_i_semester = plan.semestre[semester]
    
    if not emnelister_i_semester:
        print("Det er visst ingen emner i dette semesteret")
        return
    print(f"emner i semester {semester}")
    for emne in emnelister_i_semester:
        print(f"---{emne.kode} {emne.navn}")
        
    emnekode = input("Skriv inn koden til det emnet du vil fjerne takk")
    
    for emne in emnelister_i_semester :
        if emne.kode == emnekode:
            emnelister_i_semester.remove(emne)
            print(f"fjernet {emne.navn}")
            return
        
    print("fant ikke emnet du lette etter")
    
def valg4():
    if not emneliste._emner:
        print("ingen emner er lagt til enda :(")
        return
    print("Registrerte emner")
    for emne in emneliste._emner:
        print(f"{emne.kode} {emne.navn} {emne.stp} studiepoeng {emne.semester}")

def valg5():
    ID = input("Skriv inn ID: ")
    tittel = input("Skriv inn tittel: ")
    studieplan_ny = studieplan(ID, tittel)
    studieplan_dict[tittel] =  studieplan_ny
    print(f"Opprettet studieplan {tittel}.")

def valg6():
    while True:    
        print("Studieplaner: ")
        for navn, plan in studieplan_dict.items():
            print(f"{navn}")
        try:
            studieplan_valg = input("Velg studieplan: ")
            print(f"\n{studieplan_valg}: ")
            for semester_nr, semester_liste in studieplan_dict[studieplan_valg].semestre.items():
                print(f"\nSemester {semester_nr}:")
                if semester_liste:
                    for emne in semester_liste:
                        print(f"    - {emne}")
                else:
                    print("  - Ingen emner i dette semesteret.")
            break
        except KeyError:
            print("Velg en studieplan fra lista. Prøv på nytt.")
        


def valg7():
    print("Studieplaner")
    for plan_navn in studieplan_dict:
        print(f"---{plan_navn}")
    
    plan = input("Sjekk studieplan: ")
    if plan not in studieplan_dict:
        print("Fant ikke studieplanen.")
        return

    print("\nSjekker om studieplanen er gyldig...")
    ugyldige_semestere = []

    for semester_nr, emner_i_semester in studieplan_dict[plan].semestre.items():
        total_studiepoeng = sum(e.stp for e in emner_i_semester)
        if total_studiepoeng != 30:
            ugyldige_semestere.append((semester_nr, total_studiepoeng))

    if not ugyldige_semestere:
        print("Studieplanen er gyldig. Hvert semester har 30 studiepoeng.")
    else:
        print("Studieplanen er ikke gyldig.")
        for semester, poengsum in ugyldige_semestere:
            print(f"Semester {semester} har {poengsum} studiepoeng "
                  f"(mangler {30 - poengsum} studiepoeng).")

def valg8():
    if not studieplan_dict:
        print("Uff da ingen studieplaner enda")
        return
    emnekode = input("skriv inn emnet du vil sjekke")
    emne_obj = emneliste.finn(emnekode)
    
    if not emne_obj :
        print("uff da fant ikke emnet du lette etter")
        return
    
    planer_m_emnet = []
    
    for plan_navn, plan in studieplan_dict.items():
        emner_i_plan = sum(plan.semestre.values(),[])
        
        if emne_obj in emner_i_plan:
            planer_m_emnet.append(plan_navn)
            
        if planer_m_emnet:
            print(f"Emnet {emne_obj.navn} finnes i studieplanene:")
            for navn in planer_m_emnet:
                print(f"--- {navn}")
        else:
            print("emnet er ikke i noen studieplaner enda :-(")
            
def valg9():
    """Lagrer emner og studieplaner til CSV-filer."""
    if not studieplan_dict:
        print("Ingen studieplan tilgjengelig for lagring!")
        return  # stopper her hvis ingen planer finnes

    try:
        emne_filnavn = input("Filnavn for emner (uten .csv): ").strip() or "emner"
        plan_filnavn = input("Filnavn for studieplaner (uten .csv): ").strip() or "studieplaner"

        # --- lagre emner ---
        with open(emne_filnavn + ".csv", "w", newline="", encoding="utf-8") as fil:
            writer = csv.writer(fil)
            writer.writerow(["kode", "navn", "semester", "stp"])
            for e in emneliste._emner:
                writer.writerow([e.kode, e.navn, e.semester, e.stp])
        print(f"Lagret {len(emneliste._emner)} emner til '{emne_filnavn}.csv'.")

        # --- lagre studieplaner ---
        with open(plan_filnavn + ".csv", "w", newline="", encoding="utf-8") as fil:
            writer = csv.writer(fil)
            writer.writerow(["tittel", "ID", "semester", "emnekoder"])
            for plan in studieplan_dict.values():
                for sem_nr, emner_i_sem in plan.semestre.items():
                    koder = [e.kode for e in emner_i_sem]
                    writer.writerow([plan.tittel, plan.ID, sem_nr, ";".join(koder)])
        print(f"Lagret studieplaner til '{plan_filnavn}.csv'.")

    except Exception as e:
        print(f"Feil ved lagring: {e}")




def valg10():
    """Leser inn emner og studieplaner fra CSV-filer."""
    global emneliste, studieplan_dict
    try:
        emne_filnavn = input("Filnavn for emner (uten .csv): ").strip() or "emner"
        plan_filnavn = input("Filnavn for studieplaner (uten .csv): ").strip() or "studieplaner"

        # --- les emner ---
        emneliste._emner.clear()
        with open(emne_filnavn + ".csv", "r", encoding="utf-8") as fil:
            reader = csv.DictReader(fil)
            for rad in reader:
                nytt_emne = emne(
                    rad["kode"], rad["semester"], rad["navn"], float(rad["stp"])
                )
                emneliste._emner.append(nytt_emne)
        print(f"Leste inn {len(emneliste._emner)} emner fra '{emne_filnavn}.csv'.")

        # --- les studieplaner ---
        studieplan_dict.clear()
        with open(plan_filnavn + ".csv", "r", encoding="utf-8") as fil:
            reader = csv.DictReader(fil)
            for rad in reader:
                tittel = rad["tittel"]
                ID = rad["ID"]
                sem_nr = int(rad["semester"])
                emnekoder = rad["emnekoder"].split(";") if rad["emnekoder"] else []

                if tittel not in studieplan_dict:
                    studieplan_dict[tittel] = studieplan(ID, tittel)

                for kode in emnekoder:
                    fag = emneliste.finn(kode)
                    if fag:
                        studieplan_dict[tittel].semestre[sem_nr].append(fag)
        print(f"Leste inn {len(studieplan_dict)} studieplan(er) fra '{plan_filnavn}.csv'.")

    except FileNotFoundError:
        print("Fant ikke en av filene. Sjekk navn og prøv igjen.")
    except Exception as e:
        print(f"Feil ved innlesing: {e}")

        

def main():
    while True: #MENY   
        meny_liste() #skriver ut meny valgene 
        
        valg = int(input("\nVelg et tall fra menyen: ")) #sikkrer at input tallet blir heltall så hele programmet ikke bare krasjer...  
        if valg == 1: #Lag et nytt emne
            valg1()
        elif valg == 2: #Legg til et emne i en studieplan
            valg2()
        elif valg == 3: #Fjern et emne fra en studieplan
            valg3()
        elif valg == 4: #Skriv ut ei liste over alle registrerte emner
            valg4()
        elif valg == 5: #Lag en ny tom studieplan
            valg5()
        elif valg == 6: #Skriv ut en studieplan med hvilke emner som er i hvert semester
            valg6()
        elif valg == 7: #Sjekk om en studieplan er gyldig eller ikke
            valg7()
        elif valg == 8: #Finn hvilke studieplaner som bruker et oppgitt emne
            valg8()
        elif valg == 9:
            valg9()
        elif valg == 10:
            valg10()
        elif valg == 11: #Avslutt
            print("Avslutter programmet")
            break
        else:
            print("Feil, velg et tall mellom 1 og 11.")
    
main()